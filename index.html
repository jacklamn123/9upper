<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>9upper Online</title>

    <!-- ✅ Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }
        .hidden {
            display: none;
        }
        .chatbox {
            width: 300px;
            height: 200px;
            border: 1px solid black;
            overflow-y: auto;
            margin: 10px auto;
            text-align: left;
            padding: 5px;
            background-color: #f0f0f0;
        }
    </style>

    <script>
        // ✅ Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB1PPLZl8380-xEpyVX3z8ya9eRji2H-uk",
            authDomain: "upper-2c864.firebaseapp.com",
            databaseURL: "https://upper-2c864-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "upper-2c864",
            storageBucket: "upper-2c864.firebasestorage.app",
            messagingSenderId: "1065732661608",
            appId: "1:1065732661608:web:2db40ab8d60697b34f6dd",
            measurementId: "G-F348XKS47Q"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        var gameCode = ""; 
        var playerName = "";

        function confirmName() {
            playerName = document.getElementById("playerNameInput").value.trim();
            if (playerName === "") {
                alert("Please enter a valid name!");
                return;
            }
            document.getElementById("nameInput").classList.add("hidden");
            document.getElementById("setupArea").classList.remove("hidden");
        }

        function createGame() {
            gameCode = Math.random().toString(36).substr(2, 6).toUpperCase();
            db.ref("games/" + gameCode).set({
                status: "waiting",
                players: {},
                host: playerName,
                chat: {}
            }).then(() => {
                document.getElementById("gameCodeDisplay").innerText = gameCode;
                document.getElementById("setupArea").classList.add("hidden");
                document.getElementById("gameArea").classList.remove("hidden");
                db.ref("games/" + gameCode + "/players/" + playerName).set(true);
                listenForUpdates();
            });
        }

        function joinGame() {
            gameCode = document.getElementById("gameCodeInput").value.toUpperCase();
            if (!gameCode) {
                alert("Please enter a valid game code!");
                return;
            }
            db.ref("games/" + gameCode).get().then(snapshot => {
                if (snapshot.exists()) {
                    document.getElementById("gameCodeDisplay").innerText = gameCode;
                    document.getElementById("setupArea").classList.add("hidden");
                    document.getElementById("gameArea").classList.remove("hidden");
                    db.ref("games/" + gameCode + "/players/" + playerName).set(true);
                    listenForUpdates();
                } else {
                    alert("Game not found!");
                }
            });
        }

   function listenForUpdates() {
    db.ref("games/" + gameCode).on("value", snapshot => {
        var gameData = snapshot.val();
        if (!gameData) return;

        if (gameData.players) {
            var playerList = Object.keys(gameData.players).map(name => `<li>${name}</li>`).join("");
            document.getElementById("playerList").innerHTML = `<ul>${playerList}</ul>`;

            if (gameData.host === playerName) {
                document.getElementById("gameSettings").classList.remove("hidden");
                document.getElementById("startGameButton").classList.remove("hidden");
            }
        }

        if (gameData.status === "playing") {
            document.getElementById("waitingRoom").classList.add("hidden");
            document.getElementById("gameScreen").classList.remove("hidden");

            document.getElementById("currentRound").innerText = gameData.round;
            document.getElementById("totalRounds").innerText = gameData.totalRounds;
            document.getElementById("gameTerm").innerText = gameData.term;
            document.getElementById("playerRole").innerText = gameData.roles[playerName];

            if (gameData.roles[playerName] === "Correct Definition") {
                document.getElementById("correctDefinition").innerText = gameData.correctDefinition;
                document.getElementById("correctDefinitionBox").classList.remove("hidden");
            } else if (gameData.roles[playerName] === "Fake Definition") {
                document.getElementById("definitionInputBox").classList.remove("hidden");
            }

            if (gameData.roles[playerName] === "Judge") {
                document.getElementById("judgePanel").classList.remove("hidden");
                displayDefinitionsForJudge();
            }
        }
    });
}



function displayJudgeOptions(gameData) {
    var players = Object.keys(gameData.players);
    var judge = players.find(p => gameData.roles[p] === "Judge");

    // ✅ Filter out the Judge from the selection
    var selectablePlayers = players.filter(p => p !== judge);

    // ✅ Create buttons for each player
    var buttonsHTML = selectablePlayers.map(player =>
        `<button onclick="judgeSelectPlayer('${player}')">${player}</button>`
    ).join(" ");

    document.getElementById("judgeOptions").innerHTML = buttonsHTML;
    document.getElementById("judgePanel").classList.remove("hidden");
}


// ✅ Judge selects a player
function judgeSelectPlayer(selectedPlayer) {
    clearInterval(roundTimer); // Stop timer when judge selects

    db.ref("games/" + gameCode).once("value", snapshot => {
        let gameData = snapshot.val();
        let currentRound = gameData.round;
        let totalRounds = gameData.totalRounds;

        if (currentRound < totalRounds) {
            // Proceed to next round
            db.ref("games/" + gameCode).update({
                round: currentRound + 1
            });
            alert(`${selectedPlayer} was selected. Next round starts!`);
            startNewRound();
        } else {
            // Game over
            db.ref("games/" + gameCode).update({
                status: "ended"
            });
            alert(`Game Over! ${selectedPlayer} was the final winner.`);
        }
    });
}




function startGame() {
    fetch("9upper_terms.json")
        .then(response => response.json())
        .then(terms => {
            db.ref("games/" + gameCode).once("value", snapshot => {
                let gameData = snapshot.val();
                let players = Object.keys(gameData.players);
                if (players.length < 3) {
                    alert("At least 3 players are needed to start the game!");
                    return;
                }

                let rounds = gameData.rounds || 5; // Default 5 rounds if not set
                let timePerRound = gameData.timePerRound || 2; // Default 2 mins

                let judge = players[Math.floor(Math.random() * players.length)];
                let correctPlayer = players.filter(p => p !== judge)[Math.floor(Math.random() * (players.length - 1))];

                let roles = {};
                players.forEach(p => roles[p] = "Fake Definition");
                roles[judge] = "Judge";
                roles[correctPlayer] = "Correct Definition";

                let randomIndex = Math.floor(Math.random() * terms.length);
                let randomTerm = terms[randomIndex].term;
                let correctDefinition = terms[randomIndex].definition;

                db.ref("games/" + gameCode).update({
                    status: "playing",
                    round: 1,
                    totalRounds: rounds,
                    timePerRound: timePerRound,
                    term: randomTerm,
                    correctDefinition: correctDefinition,
                    roles: roles
                });

                startRoundTimer(timePerRound);
            });
        })
        .catch(error => console.error("Error loading terms:", error));
}
var roundTimer;

function startRoundTimer(timeLimit) {
    let timeLeft = timeLimit * 60; // Convert minutes to seconds
    document.getElementById("roundTimer").innerText = `Time Left: ${timeLeft}s`;

    roundTimer = setInterval(() => {
        timeLeft--;
        document.getElementById("roundTimer").innerText = `Time Left: ${timeLeft}s`;

        if (timeLeft <= 0) {
            clearInterval(roundTimer);
            endRound(); // Auto-end round if time runs out
        }
    }, 1000); // Update every second
}

function startNewRound() {
    fetch("9upper_terms.json")
        .then(response => response.json())
        .then(terms => {
            db.ref("games/" + gameCode).once("value", snapshot => {
                let gameData = snapshot.val();
                let players = Object.keys(gameData.players);

                let judge = players[Math.floor(Math.random() * players.length)];
                let correctPlayer = players.filter(p => p !== judge)[Math.floor(Math.random() * (players.length - 1))];

                let roles = {};
                players.forEach(p => roles[p] = "Fake Definition");
                roles[judge] = "Judge";
                roles[correctPlayer] = "Correct Definition";

                let randomIndex = Math.floor(Math.random() * terms.length);
                let randomTerm = terms[randomIndex].term;
                let correctDefinition = terms[randomIndex].definition;

                db.ref("games/" + gameCode).update({
                    term: randomTerm,
                    correctDefinition: correctDefinition,
                    roles: roles
                });

                startRoundTimer(gameData.timePerRound);
            });
        })
        .catch(error => console.error("Error loading terms:", error));
}

        function sendChatMessage() {
            var message = document.getElementById("chatInput").value.trim();
            if (message === "") return;
            db.ref("games/" + gameCode + "/chat").push(playerName + ": " + message);
            document.getElementById("chatInput").value = "";
        }
        function updateRoundsDisplay() {
    document.getElementById("roundsDisplay").innerText = document.getElementById("roundsSlider").value;
}

function updateTimeDisplay() {
    document.getElementById("timeDisplay").innerText = document.getElementById("timeSlider").value;
}
function saveGameSettings() {
    if (playerName !== gameData.host) {
        alert("Only the host can set game settings!");
        return;
    }

    let rounds = document.getElementById("roundsSlider").value;
    let timePerRound = document.getElementById("timeSlider").value;

    db.ref("games/" + gameCode).update({
        rounds: parseInt(rounds),
        timePerRound: parseInt(timePerRound)
    });

    alert("Game settings saved!");
}

    </script>
</head>
<body>
    <h1>9upper Online Multiplayer</h1>

    <div id="nameInput">
        <input type="text" id="playerNameInput" placeholder="Enter Your Name">
        <button onclick="confirmName()">Continue</button>
    </div>

    <div id="setupArea" class="hidden">
        <button onclick="createGame()">Create Game</button>
        <input type="text" id="gameCodeInput" placeholder="Enter Game Code">
        <button onclick="joinGame()">Join Game</button>
    </div>

    <div id="gameArea" class="hidden">
        <h2>Game Code: <span id="gameCodeDisplay"></span></h2>

        <div id="waitingRoom">
    <h2>Players in Room</h2>
    <div id="playerList"></div>

    <!-- ✅ Game Settings (Only Host Can Adjust) -->
    <div id="gameSettings" class="hidden">
        <h3>Game Settings</h3>
        
        <label for="roundsSlider">Rounds:</label>
        <input type="range" id="roundsSlider" min="5" max="20" step="5" value="10" 
               oninput="updateRoundsDisplay()">
        <span id="roundsDisplay">10</span>

        <br><br>

        <label for="timeSlider">Time per Round (minutes):</label>
        <input type="range" id="timeSlider" min="1" max="10" step="1" value="5" 
               oninput="updateTimeDisplay()">
        <span id="timeDisplay">5</span>

        <br><br>

        <button id="saveSettingsButton" onclick="saveGameSettings()">Save Settings</button>
    </div>

    <button id="startGameButton" class="hidden" onclick="startGame()">Start Game</button>
</div>


<div id="gameScreen" class="hidden">
    <h3>Round <span id="currentRound"></span> of <span id="totalRounds"></span></h3>
    <h3 id="roundTimer">Time Left: --</h3>
    <h3>Term: <span id="gameTerm"></span></h3>
    <h3>Your Role: <span id="playerRole"></span></h3>

    <div id="correctDefinitionBox" class="hidden">
        <h3>Correct Definition: <span id="correctDefinition"></span></h3>
    </div>

    <div id="judgePanel" class="hidden">
        <h3>Judge: Pick the correct player</h3>
        <div id="judgeOptions"></div>
    </div>

    <div class="chatbox">
        <div id="chatMessages"></div>
    </div>
    <input type="text" id="chatInput" placeholder="Type a message">
    <button onclick="sendChatMessage()">Send</button>
</div>



        <!-- ✅ Chatbox Added -->
        <div class="chatbox">
            <div id="chatMessages"></div>
        </div>
        <input type="text" id="chatInput" placeholder="Type a message">
        <button onclick="sendChatMessage()">Send</button>

    </div>
</body>
</html>
